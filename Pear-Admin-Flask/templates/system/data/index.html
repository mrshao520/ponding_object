<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="utf-8" />
    <title>数据管理</title>
    <meta name="renderer" content="webkit" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  </head>
  <body>
    <!-- ############### 表 ################# -->
    <div style="padding: 16px">
      <div class="layui-card">
        <div class="layui-card-body">
          <form class="layui-form layui-row layui-col-space16">
            <div class="layui-col-md2">
              <div class="layui-input-wrap">
                <div class="layui-input-prefix">
                  <i class="layui-icon layui-icon-username"></i>
                </div>
                <input type="text" name="id" value="" placeholder="请输入id" class="layui-input" lay-affix="clear" />
              </div>
            </div>
            <div class="layui-col-md2">
              <div class="layui-input-wrap">
                <div class="layui-input-prefix">
                  <i class="layui-icon layui-icon-location"></i>
                </div>
                <input type="text" name="city" placeholder="请输入城市" lay-affix="clear" class="layui-input" />
              </div>
            </div>
            <div class="layui-col-md2">
              <div class="layui-input-wrap">
                <div class="layui-input-prefix">
                  <i class="layui-icon layui-icon-date"></i>
                </div>
                <input type="text" name="start_datetime" id="ponding-start-time" placeholder="请输入开始时间" class="layui-input ponding-start-time" />
              </div>
            </div>
            <div class="layui-col-md2">
              <div class="layui-input-wrap">
                <div class="layui-input-prefix">
                  <i class="layui-icon layui-icon-date"></i>
                </div>
                <input type="text" name="end_datetime" id="ponding-end-time" placeholder="请输入结束时间" class="layui-input ponding-end-time" />
              </div>
            </div>
            <div class="layui-col-md2">
              <div class="layui-btn-container">
                <button class="layui-btn" lay-submit lay-filter="ponding-form-search">Search</button>
                <button type="reset" class="layui-btn layui-btn-primary">Clear</button>
              </div>
            </div>
          </form>
          <table class="layui-hide" id="ponding-table" lay-filter="ponding-table"></table>
        </div>
      </div>
    </div>

    <!-- ############### 弹出的表单窗口 ################ -->
    <form class="layui-form" lay-filter="ponding-form" id="ponding-form" action="" style="padding: 15px; display: none">
      <div class="layui-form-item">
        <label class="layui-form-label">ID</label>
        <div class="layui-input-block">
          <input type="text" name="id" value="0" lay-verify="required" autocomplete="off" class="layui-input" disabled />
        </div>
      </div>
      <div class="layui-form-item">
        <div class="layui-inline">
          <label class="layui-form-label">请选择日期</label>
          <div class="layui-input-inline">
            <input type="text" name="date" class="layui-input" id="ponding-form-date" lay-verify="required" placeholder="yyyy-MM-dd HH:mm:ss" />
          </div>
        </div>
      </div>
      <div class="layui-form-item">
        <label class="layui-form-label">时间</label>
        <div class="layui-input-block">
          <input type="text" name="time" placeholder="请输入时间" autocomplete="off" class="layui-input" />
        </div>
      </div>
      <div class="layui-form-item">
        <div class="layui-inline">
          <label class="layui-form-label">请设置格式化时间</label>
          <div class="layui-input-inline">
            <input type="text" name="format_time" class="layui-input" id="ponding-form-format-time" placeholder="yyyy-MM-dd" />
          </div>
        </div>
      </div>
      <div class="layui-form-item">
        <label class="layui-form-label">城市</label>
        <div class="layui-input-block">
          <input type="text" name="city" placeholder="请输入城市" lay-verify="required" autocomplete="off" class="layui-input" />
        </div>
      </div>
      <div class="layui-form-item">
        <label class="layui-form-label">地点</label>
        <div class="layui-input-block">
          <input type="text" name="position" placeholder="请输入地点" lay-verify="required" autocomplete="off" class="layui-input" />
        </div>
      </div>
      <div class="layui-form-item">
        <label class="layui-form-label">经度</label>
        <div class="layui-input-block">
          <input type="text" name="longitude" placeholder="请输入经度" lay-verify="required" autocomplete="off" class="layui-input" />
        </div>
      </div>
      <div class="layui-form-item">
        <label class="layui-form-label">纬度</label>
        <div class="layui-input-block">
          <input type="text" name="latitude" placeholder="请输入纬度" lay-verify="required" autocomplete="off" class="layui-input" />
        </div>
      </div>
      <div class="layui-form-item">
        <label class="layui-form-label">深度值</label>
        <div class="layui-input-block">
          <input type="text" name="depth_value" placeholder="请输入深度值" autocomplete="off" class="layui-input" />
        </div>
      </div>
      <div class="layui-form-item">
        <label class="layui-form-label">格式化深度值</label>
        <div class="layui-input-block">
          <input type="text" name="format_depth_value" placeholder="请输入格式化深度值" autocomplete="off" class="layui-input" />
        </div>
      </div>
      <div class="layui-form-item">
        <label class="layui-form-label">备注</label>
        <div class="layui-input-block">
          <input type="text" name="description" placeholder="请输入备注" autocomplete="off" class="layui-input" />
        </div>
      </div>

      <div class="layui-form-item">
        <div class="layui-input-block">
          <button type="submit" class="layui-btn" lay-submit lay-filter="ponding-form-add">立即提交</button>
          <button type="reset" class="layui-btn layui-btn-primary">重置</button>
        </div>
      </div>
    </form>

    <!-- ############### 表工具栏右侧 ################ -->
    <script type="text/html" id="ponding-toolbar">
      <div class="layui-btn-container">
        <button class="layui-btn layui-btn-sm" lay-event="ponding-toolbar-add">
          新增数据
        </button>
      
        <button class="layui-btn layui-btn-sm" lay-event="ponding-toolbar-get-check-data">
          获取选中行数据
        </button>
      
        <button class="layui-btn layui-btn-sm" lay-event="ponding-toolbar-get-all-data">
          获取全部数据
        </button>
      </div>
    </script>

    <!-- ############### 每行的操作按钮 ################ -->
    <script type="text/html" id="ponding-tool">
      <div class="layui-btn-container">
        <button class="layui-btn layui-btn-sm layui-bg-blue" lay-event="ponding-tool-edit">
          编辑
        </button>
        <button class="layui-btn layui-btn-sm layui-bg-red" lay-event="ponding-tool-del">
          删除
        </button>
        <a class="layui-btn layui-btn-sm" lay-event="ponding-tool-more">
          更多
          <i class="layui-icon layui-icon-down"></i>
        </a>
      </div>
    </script>

    <script>
      layui.use(function () {
        var table = layui.table
        var $ = layui.$
        var form = layui.form
        var laydate = layui.laydate
        var popup = layui.popup
        var dropdown = layui.dropdown
      
        var ponding_keys = {}
        var ponding_form_search_data = {}
      
        let user_id = -1
      
        // 创建渲染实例
        table.render({
          elem: '#ponding-table',
          id: 'ponding-table',
          url: '/api/v1/function/ponding', // 此处为静态模拟数据，实际使用时需换成真实接口
          height: 'full-35', // 最大高度减去其他容器已占有的高度差
          toolbar: '#ponding-toolbar',
          page: true,
          // 表格工具栏右侧按钮
          defaultToolbar: [
            'filter',
            'exports',
            'print',
            {
              title: '更多导出功能待开发', // 自定义自定义工具栏按钮
              // layEvent: 'LAYTABLE_TIPS',
              icon: 'layui-icon-tips'
            }
          ],
          // totalRow: true, // 开启合计行
          cols: [
            (function () {
              // 表头
              var arr = [
                { type: 'checkbox', fixed: 'left' },
                //标题栏
                { field: 'id', title: 'ID', fixed: 'left', minWidth: 60, expandedWidth: 60, sort: true },
                { field: 'date', title: '日期', minWidth: 180, expandedWidth: 180, sort: true },
                { field: 'time', title: '时间', minWidth: 80, expandedWidth: 80 },
                { field: 'format_time', title: '格式化时间', minWidth: 80, expandedWidth: 80 },
                { field: 'city', title: '城市', minWidth: 80, expandedWidth: 80, sort: true },
                { field: 'position', title: '地点', minWidth: 200, expandedWidth: 200, sort: true },
                { field: 'longitude', title: '经度', minWidth: 140, expandedWidth: 140, sort: true },
                { field: 'latitude', title: '纬度', minWidth: 140, expandedWidth: 140, sort: true },
                { field: 'depth_value', title: '深度值', minWidth: 100, expandedWidth: 100 },
                { field: 'format_depth_value', title: '格式化深度值', minWidth: 100, expandedWidth: 100 },
                { field: 'description', title: '备注', minWidth: 180, expandedWidth: 180 },
                {
                  fixed: 'right',
                  title: '操作',
                  width: 200,
                  align: 'center',
                  toolbar: '#ponding-tool' // 设置每行的工具按钮
                }
              ]
              // 初始化筛选状态
              var local = layui.data('ponding-filter-local') // 获取对应的本地记录
              // console.log(local) // {description: true, time: true, position: true}
              layui.each(arr, function (index, item) {
                // console.log(index)  0-9
                // console.log(item) // {field: 'time', title: '时间', minWidth: 80, expandedWidth: 80}
                if (item.field in local) {
                  item.hide = local[item.field]
                  ponding_keys[item.field] = local[item.field]
                } else if (item.field) {
                  ponding_keys[item.field] = false
                }
              })
              // console.log(ponding_keys)
              return arr
            })()
          ],
          done: function () {
            // 记录筛选状态
            var that = this
            that.elem.next().on('mousedown', 'input[lay-filter="LAY_TABLE_TOOL_COLS"]+', function () {
              var input = $(this).prev()[0]
              // 此处表名可任意定义
              // console.log(input.name)    // city
              // console.log(input.checked) // true
              ponding_keys[input.name] = input.checked
              // console.log(ponding_keys)
              layui.data('ponding-filter-local', {
                key: input.name,
                value: input.checked
              })
            })
          }
        })
      
        // 表头工具栏事件
        table.on('toolbar(ponding-table)', function (obj) {
          var id = obj.config.id // ponding-table
          var checkStatus = table.checkStatus(id)
          // console.log(table)
          //console.log(obj)
          //console.log(obj.config.cols)
          //console.log(Object.keys(obj.config.cols[0]))
          // console.log(checkStatus)
          var othis = lay(this)
      
          if (obj.event === 'ponding-toolbar-add') {
            // 增加数据
            $('#ponding-form')[0].reset()
            layer.open({
              type: 1,
              shade: false,
              content: $('#ponding-form'),
              area: ['50%', '80%']
            })
            form.render($('#ponding-form'))
          } else if (obj.event === 'ponding-toolbar-get-check-data') {
            // 获取选中行数据
            var data = checkStatus.data
            //console.log(data)
            if (data.length < 1) {
              layer.alert('请选择一行')
            } else {
              var keys = []
              // layer.alert(layui.util.escape(JSON.stringify(data)));
              for ([key, value] of Object.entries(ponding_keys)) {
                if (!value) {
                  // 未被选中，即未被隐藏
                  keys.push(key)
                }
              }
              // console.log(keys)
              //console.log(data.length);
              // console.log(data)
              //console.log(keys)
              var datas = data.map((item) => {
                return Object.fromEntries(keys.map((key) => [key, item[key]]))
              })
              // console.log(datas)
      
              table.exportFile(keys, datas, 'csv')
              popup.success('已下载 ' + data.length + ' 行数据')
            }
          } else if (obj.event === 'ponding-toolbar-get-all-data') {
            // console.log(ponding_form_search_data)
            // 获取所有数据
            $.ajax({
              url: `/api/v1/function/ponding`,
              data: ponding_form_search_data,
              type: 'GET',
              contentType: 'application/json',
              headers: {
                'X-CSRF-TOKEN': getCookie('csrf_access_token')
              },
              success: function (res) {
                if (!res.code) {
                  if (res.count > 0) {
                    var keys = []
                    for ([key, value] of Object.entries(ponding_keys)) {
                      if (!value) {
                        // 未被选中，即未被隐藏
                        keys.push(key)
                      }
                    }
                    var datas = res.data.map((item) => {
                      return Object.fromEntries(keys.map((key) => [key, item[key]]))
                    })
                    table.exportFile(keys, datas, 'csv')
                    popup.success('已成功下载' + res.count + ' 行数据')
                  } else {
                    popup.failure('数据为空，下载失败')
                  }
                }
              },
              error: function (XMLHttpRequest, textStatus, errorThrown) {
                popup.failure(XMLHttpRequest.responseJSON.msg)
              }
            })
          } else if (obj.event === 'ponding-toolbar-get-data') {
            // 获取当前页数据
            var getData = table.getData(id)
            // console.log(getData)
            layer.alert(layui.util.escape(JSON.stringify(getData)))
          }
        })
      
        // 表内工具栏事件
        table.on('tool(ponding-table)', function (obj) {
          if (obj.event === 'ponding-tool-edit') {
            // 编辑
            form.val('ponding-form', obj.data) // 将数据填充到表格中
            layer.open({
              type: 1,
              shade: false,
              content: $('#ponding-form'),
              area: ['50%', '80%']
            })
          } else if (obj.event === 'ponding-tool-del') {
            // 删除
            layer.confirm('真的删除行 [id: ' + obj.data.id + '] 么', function (index) {
              obj.del() // 删除对应行（tr）的DOM结构
              layer.close(index)
              // 向服务端发送删除指令
              // 删除
              $.ajax({
                url: `/api/v1/function/ponding/${obj.data.id}`,
                type: 'DELETE',
                contentType: 'application/json',
                headers: {
                  'X-CSRF-TOKEN': getCookie('csrf_access_token')
                },
                success: function (res) {
                  if (!res.code) {
                    table.reloadData('ponding-table') // 刷新表格
                    popup.success(res.msg)
                  }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                  popup.failure(XMLHttpRequest.responseJSON.msg)
                }
              })
            })
          } else if (obj.event == 'ponding-tool-more') {
            // 更多 - 下拉菜单
            dropdown.render({
              elem: this, // 触发事件的 DOM 对象
              SHOW: true, // 外部事件触发即显示
              data: [
                {
                  title: '查看',
                  id: 'detail'
                },
                {
                  title: '删除',
                  id: 'delete'
                }
              ],
              click: function (menudata) {
                if (menudata.id == 'detail') {
                  // console.log(obj.data)
                  // layer.msg(obj.data.id)
                  layer.alert(layui.util.escape(JSON.stringify(obj.data)))
                } else if (menudata.id == 'delete') {
                  // 删除
                  layer.confirm('真的删除行 [id: ' + obj.data.id + '] 么', function (index) {
                    obj.del() // 删除对应行（tr）的DOM结构
                    layer.close(index)
                    // 向服务端发送删除指令
                    // 删除
                    $.ajax({
                      url: `/api/v1/function/ponding/${obj.data.id}`,
                      type: 'DELETE',
                      contentType: 'application/json',
                      headers: {
                        'X-CSRF-TOKEN': getCookie('csrf_access_token')
                      },
                      success: function (res) {
                        if (!res.code) {
                          table.reloadData('ponding-table') // 刷新表格
                          popup.success(res.msg)
                        }
                      },
                      error: function (XMLHttpRequest, textStatus, errorThrown) {
                        popup.failure(XMLHttpRequest.responseJSON.msg)
                      }
                    })
                  })
                }
              },
              align: 'right', // 右对齐弹出
              style: 'box-shadow: 1px 1px 10px rgb(0 0 0 / 12%);' // 设置额外样式
            })
          }
        })
      
        // 表单提交按钮触发
        form.on('submit(ponding-form-add)', function (data) {
          var field = data.field
          let method, url
          if (field.id == 0) {
            // 增加
            field.id = null
            method = 'POST'
            url = '/api/v1/function/ponding'
          } else {
            // 修改
            method = 'PUT'
            url = `/api/v1/function/ponding/${field.id}`
          }
          $.ajax({
            url: url,
            type: method,
            contentType: 'application/json',
            headers: {
              'X-CSRF-TOKEN': getCookie('csrf_access_token')
            },
            data: JSON.stringify(field),
            success: function (res) {
              if (!res.code) {
                layer.closeAll()
                table.reloadData('ponding-table')
                popup.success(res.msg)
              }
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
              popup.failure(XMLHttpRequest.responseJSON.msg)
            }
          })
          return false;
        })
      
        form.on('submit(ponding-form-search)', function (data) {
          var field = data.field; // 获得表单字段
          // console.log(field) // {id: '1', city: '北京', start_datetime: '2024-06-19 00:00:00', end_datetime: ''}
          ponding_form_search_data = field;
          // 执行搜索重载
          table.reload('ponding-table', {
            page: {
              curr: 1  // 重新从第一页开始
            },
            where: field, // 搜索的字段
          });

          return false; // 阻止默认 form 跳转
        })
      
        // 时间选择器
        laydate.render({
          elem: '#ponding-form-date',
          type: 'datetime'
        })

        laydate.render({
          elem: '#ponding-form-format-time',
          type: 'date'
        })
      
        laydate.render({
          elem: '.ponding-start-time',
          type: 'datetime'
        })
      
        laydate.render({
          elem: '.ponding-end-time',
          type: 'datetime'
        })
      
        
      })
    </script>
  </body>
</html>
