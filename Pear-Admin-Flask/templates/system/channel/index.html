<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="utf-8" />
    <title>检索渠道管理</title>
    <meta name="renderer" content="webkit" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  </head>
  <body>
    <!-- ############### 表 ################# -->
    <div style="padding: 16px">
      <div class="layui-card">
        <div class="layui-card-body">
          <table class="layui-hide" id="channel-table" lay-filter="channel-table"></table>
        </div>
      </div>
    </div>

    <!-- ############### 弹出的表单窗口 ################ -->
    <form class="layui-form" lay-filter="channel-form" id="channel-form" action="" style="padding: 15px; display: none">
      <div class="layui-form-item">
        <label class="layui-form-label">ID</label>
        <div class="layui-input-block">
          <input type="text" name="id" value="0" lay-verify="required" autocomplete="off" class="layui-input" disabled />
        </div>
      </div>
      <div class="layui-form-item">
        <label class="layui-form-label">检索名称</label>
        <div class="layui-input-block">
          <input type="text" name="channel" placeholder="请输入检索渠道名称" lay-verify="required|word_num" autocomplete="off" class="layui-input" />
        </div>
      </div>
      <div class="layui-form-item">
        <label class="layui-form-label">命令</label>
        <div class="layui-input-block">
          <input type="text" name="command" placeholder="请输入输入命令，city表示城市，start_datetime表示开始时间，end_datetime表示结束时间" lay-verify="required|word_num" autocomplete="off" class="layui-input" />
        </div>
      </div>
      <div class="layui-form-item">
        <div class="layui-input-block">
          <button type="submit" class="layui-btn" lay-submit lay-filter="channel-form-add">立即提交</button>
          <button type="reset" class="layui-btn layui-btn-primary">重置</button>
        </div>
      </div>
    </form>

    <!-- ############### 弹出的表单窗口 ################ -->
    <form class="layui-form" lay-filter="channel-edit-form" id="channel-edit-form" action="" style="padding: 15px; display: none">
      <div class="layui-form-item">
        <label class="layui-form-label">ID</label>
        <div class="layui-input-block">
          <input type="text" name="id" value="0" lay-verify="required" autocomplete="off" class="layui-input" disabled />
        </div>
      </div>
      <div class="layui-form-item">
        <label class="layui-form-label">检索名称</label>
        <div class="layui-input-block">
          <input type="text" name="channel" placeholder="请输入输入检索渠道名称" lay-verify="required|word_num" autocomplete="off" class="layui-input" />
        </div>
      </div>
      <div class="layui-form-item">
        <label class="layui-form-label">命令</label>
        <div class="layui-input-block">
          <input type="text" name="command" placeholder="请输入输入命令，city表示城市，start_datetime表示开始时间，end_datetime表示结束时间" lay-verify="required|word_num" autocomplete="off" class="layui-input" />
        </div>
      </div>
      <div class="layui-form-item">
        <label class="layui-form-label">错误信息</label>
        <div class="layui-input-block">
          <textarea placeholder="错误信息和异常" name="information" class="layui-textarea"></textarea>
        </div>
      </div>
      <div class="layui-form-item">
        <div class="layui-input-block">
          <button type="submit" class="layui-btn" lay-submit lay-filter="channel-edit-form-add">立即提交</button>
          <button type="reset" class="layui-btn layui-btn-primary">重置</button>
        </div>
      </div>
    </form>

    <!-- ############### 表工具栏右侧 ################ -->
    <script type="text/html" id="channel-toolbar">
      <div class="layui-btn-container">
        <button class="layui-btn layui-btn-sm" lay-event="channel-toolbar-add">
          新增检索渠道
        </button>
      </div>
    </script>

    <!-- ############### 每行的操作按钮 ################ -->
    <script type="text/html" id="channel-tool">
      <div class="layui-btn-container">
        <button class="layui-btn layui-btn-sm  layui-bg-blue" lay-event="channel-tool-edit">
          编辑
        </button>
        <button class="layui-btn layui-btn-sm layui-bg-red" lay-event="channel-tool-del">
          删除
        </button>
        <a class="layui-btn layui-btn-sm" lay-event="channel-tool-more">
          更多
          <i class="layui-icon layui-icon-down"></i>
        </a>
      </div>
    </script>

    <script>
      layui.use(function () {
        var table = layui.table
        var $ = layui.$
        var form = layui.form
        var laydate = layui.laydate
        var popup = layui.popup
        var dropdown = layui.dropdown
      
        // 创建渲染实例
        table.render({
          elem: '#channel-table',
          id: 'channel-table',
          url: '/api/v1/function/channel', // 此处为静态模拟数据，实际使用时需换成真实接口
          height: 'full-35', // 最大高度减去其他容器已占有的高度差
          toolbar: '#channel-toolbar',
          page: true,
          // 表格工具栏右侧按钮
          defaultToolbar: [
            'filter',
            'exports',
            'print',
            {
              title: '更多导出功能待开发', // 自定义自定义工具栏按钮
              // layEvent: 'LAYTABLE_TIPS',
              icon: 'layui-icon-tips'
            }
          ],
          // totalRow: true, // 开启合计行
          cols: [
            (function () {
              // 表头
              var arr = [
                { type: 'checkbox', fixed: 'left' },
                //标题栏
                { field: 'id', title: 'ID', fixed: 'left', minWidth: 60, expandedWidth: 60, sort: true },
                { field: 'channel', title: '检索渠道', minWidth: 140, expandedWidth: 100, sort: true },
                { field: 'command', title: '命令', minWidth: 350, expandedWidth: 100 },
                { field: 'effective_number', title: '今日检索有效数', minWidth: 100, expandedWidth: 100, sort: true ,hide: true},
                { field: 'number', title: '今日检索总数', minWidth: 100, expandedWidth: 100 ,hide: true},
                { field: 'total_effective_number', title: '检索有效总数', minWidth: 100, expandedWidth: 100, sort: true,hide: true },
                { field: 'total_number', title: '检索总数', minWidth: 100, expandedWidth: 100, sort: true ,hide: true},
                {
                  field: 'status',
                  title: '状态',
                  minWidth: 60,
                  expandedWidth: 60,
                  sort: true,
                  templet: function (d) {
                    if (d.status) {
                      return '<button type="button" class="layui-btn layui-btn-sm layui-btn-radius">正常</button>'
                    } else {
                      return '<button type="button" class="layui-btn layui-btn-sm layui-btn-danger layui-btn-radius">异常</button>'
                    }
                  }
                },
                { field: 'information', title: '错误信息和异常', minWidth: 200, expandedWidth: 200 },
                {
                  fixed: 'right',
                  title: '操作',
                  width: 200,
                  align: 'center',
                  toolbar: '#channel-tool' // 设置每行的工具按钮
                }
              ]
              // 初始化筛选状态
              var local = layui.data('channel-filter-local') // 获取对应的本地记录
              // console.log(local) // {description: true, time: true, position: true}
              layui.each(arr, function (index, item) {
                // console.log(index)  0-9
                // console.log(item) // {field: 'time', title: '时间', minWidth: 80, expandedWidth: 80}
                if (item.field in local) {
                  item.hide = local[item.field]
                }
              })
              // console.log(channel_keys)
              return arr
            })()
          ],
          done: function () {
            // 记录筛选状态
            var that = this
            that.elem.next().on('mousedown', 'input[lay-filter="LAY_TABLE_TOOL_COLS"]+', function () {
              var input = $(this).prev()[0]
              // 此处表名可任意定义
              // console.log(input.name)    // city
              // console.log(input.checked) // true
              // console.log(channel_keys)
              layui.data('channel-filter-local', {
                key: input.name,
                value: input.checked
              })
            })
          }
        })
      
        // 表头工具栏事件
        table.on('toolbar(channel-table)', function (obj) {
          if (obj.event === 'channel-toolbar-add') {
            // 增加数据
            $('#channel-form')[0].reset()
            layer.open({
              type: 1,
              shade: false,
              content: $('#channel-form'),
              area: ['50%', '80%']
            })
            form.render($('#channel-form'))
          }
        })
      
        // 表内工具栏事件
        table.on('tool(channel-table)', function (obj) {
          if (obj.event === 'channel-tool-edit') {
            // 编辑
            form.val('channel-edit-form', obj.data) // 将数据填充到表格中
            layer.open({
              type: 1,
              shade: false,
              content: $('#channel-edit-form'),
              area: ['50%', '80%']
            })
          } else if (obj.event === 'channel-tool-del') {
            // 删除
            layer.confirm('真的删除行 [id: ' + obj.data.id + '] 么', function (index) {
              obj.del() // 删除对应行（tr）的DOM结构
              layer.close(index)
              // 向服务端发送删除指令
              // 删除
              $.ajax({
                url: `/api/v1/function/channel/${obj.data.id}`,
                type: 'DELETE',
                contentType: 'application/json',
                headers: {
                  'X-CSRF-TOKEN': getCookie('csrf_access_token')
                },
                success: function (res) {
                  if (!res.code) {
                    table.reloadData('channel-table') // 刷新表格
                    popup.success(res.msg)
                  }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                  popup.failure(XMLHttpRequest.responseJSON.msg)
                }
              })
            })
          } else if (obj.event == 'channel-tool-more') {
            // 更多 - 下拉菜单
            dropdown.render({
              elem: this, // 触发事件的 DOM 对象
              SHOW: true, // 外部事件触发即显示
              data: [
                {
                  title: '查看',
                  id: 'detail'
                },
                {
                  title: '删除',
                  id: 'delete'
                }
              ],
              click: function (menudata) {
                if (menudata.id == 'detail') {
                  // console.log(obj.data)
                  // layer.msg(obj.data.id)
                  layer.alert(layui.util.escape(JSON.stringify(obj.data)))
                } else if (menudata.id == 'delete') {
                  // 删除
                  layer.confirm('真的删除行 [id: ' + obj.data.id + '] 么', function (index) {
                    obj.del() // 删除对应行（tr）的DOM结构
                    layer.close(index)
                    // 向服务端发送删除指令
                    // 删除
                    $.ajax({
                      url: `/api/v1/function/channel/${obj.data.id}`,
                      type: 'DELETE',
                      contentType: 'application/json',
                      headers: {
                        'X-CSRF-TOKEN': getCookie('csrf_access_token')
                      },
                      success: function (res) {
                        if (!res.code) {
                          table.reloadData('channel-table') // 刷新表格
                          popup.success(res.msg)
                        }
                      },
                      error: function (XMLHttpRequest, textStatus, errorThrown) {
                        popup.failure(XMLHttpRequest.responseJSON.msg)
                      }
                    })
                  })
                }
              },
              align: 'right', // 右对齐弹出
              style: 'box-shadow: 1px 1px 10px rgb(0 0 0 / 12%);' // 设置额外样式
            })
          }
        })

        // 表单 自定义验证规则
        form.verify({
          otherReq: function (value, item) {
            var $ = layui.$
            var verifyName = $(item).attr('name'),
              verifyType = $(item).attr('type'),
              formElem = $(item).parents('.layui-form'), //获取当前所在的form元素，如果存在的话
              verifyElem = formElem.find('input[name=' + verifyName + ']'), //获取需要校验的元素
              isTrue = verifyElem.is(':checked'), //是否命中校验
              focusElem = verifyElem.next().find('i.layui-icon') //焦点元素
            if (!isTrue || !value) {
              //定位焦点
              focusElem.css(verifyType == 'radio' ? { color: '#FF5722' } : { 'border-color': '#FF5722' })
              //对非输入框设置焦点
              focusElem
                .first()
                .attr('tabIndex', '1')
                .css('outline', '0')
                .blur(function () {
                  focusElem.css(verifyType == 'radio' ? { color: '' } : { 'border-color': '' })
                })
                .focus()
              return '必填项不能为空'
            }
          },
          word_num: function(value, item){
            var varify_name = $(item).attr('name')
            if (value.length > 60){
              popup.failure(varify_name + " 的输入字数请限制在 60 以内!")
              return '输入字数请限制在 60 以内!'
            }
          }
        })
      
        // 表单提交按钮触发
        form.on('submit(channel-form-add)', function (data) {
          var field = data.field
          let method, url
      
          // console.log(field)
          if (field.id == 0) {
            // 增加
            field.id = null
            method = 'POST'
            url = '/api/v1/function/channel'
          } else {
            // 修改
            method = 'PUT'
            url = `/api/v1/function/channel/${field.id}`
          }
          $.ajax({
            url: url,
            type: method,
            contentType: 'application/json',
            headers: {
              'X-CSRF-TOKEN': getCookie('csrf_access_token')
            },
            data: JSON.stringify(field),
            success: function (res) {
              if (!res.code) {
                layer.closeAll()
                table.reloadData('channel-table')
                popup.success(res.msg)
              }
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
              popup.failure(XMLHttpRequest.responseJSON.msg)
            }
          })
          return false
        })

        // 表单提交按钮触发
        form.on('submit(channel-edit-form-add)', function (data) {
          var field = data.field
          let method, url
      
          // console.log(field)
          if (field.id == 0) {
            // 增加
            field.id = null
            method = 'POST'
            url = '/api/v1/function/channel'
          } else {
            // 修改
            method = 'PUT'
            url = `/api/v1/function/channel/${field.id}`
          }
          $.ajax({
            url: url,
            type: method,
            contentType: 'application/json',
            headers: {
              'X-CSRF-TOKEN': getCookie('csrf_access_token')
            },
            data: JSON.stringify(field),
            success: function (res) {
              if (!res.code) {
                layer.closeAll()
                table.reloadData('channel-table')
                popup.success(res.msg)
              }
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
              popup.failure(XMLHttpRequest.responseJSON.msg)
            }
          })
          return false
        })

        
      
        
      })
    </script>
  </body>
</html>
